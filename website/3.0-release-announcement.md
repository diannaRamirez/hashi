# Announcement: Upcoming v3 of the Azure Provider
Version 3.0 of the Azure Provider will be a major release, this means this will include breaking changes - in addition to new features and enhancements available in regular releases.

During the development of v2.0 of the Azure Provider we used Feature Toggling to allow us to continue shipping releases (to support the many new capabilities of Azure) while working on major features and changes for the 2.0 release. This approach worked well, allowing us to iteratively add new features for 2.0 and subsequently allowing users to try these out - which provided invaluable feedback. Subsequently, we’re using the same approach for 3.0.

## Pinning your Provider Version

You can pin the version of the Provider using the `required_providers` block in Terraform 0.13 and later.  Note: earlier versions of Terraform require a different approach; however, we’d recommend upgrading to Terraform 1.0.

```
terraform {
  required_providers {
    azurerm = {
      source = "hashicorp/azurerm"
      version = "= 2.85.0"
    }
  }
}
```

.. or to any 2.x release:

```
terraform {
  required_providers {
    azurerm = {
      source = "hashicorp/azurerm"
      version = "~> 2.0"
    }
  }
}
```

More information on how to [pin the version of a Terraform Provider](https://www.terraform.io/docs/language/providers/configuration.html#provider-versions) can be found on the Terraform Website.

## What’s Planned for 3.0?
While there’s many features will make up v3 of the Azure Provider, we’re looking to add support for the following new major features:

* [New Data Sources and Resources for App Service / Function Apps](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/guides/3.0-app-service-beta) and their supporting resources.
* Key Vault - Soft Delete Recovery/Purging for Certificates, Keys and Secrets.
* Investigating default values for Location, Resource Group, and potentially others within provider block
* Switching to Microsoft Graph instead of the deprecated Azure Active Directory Graph API. Includes using MSAL instead of ADAL for authentication.


In addition - since this is a major version of the Azure Provider - we intend to update some existing behaviors, including:

* **Application Gateway**
    * We'll be updating the behavior of the nested items to be Sets instead of Lists where required, meaning that the order of these items no longer matters. Note that if you're referencing these nested items within your Terraform Configuration, then this may require some code changes.
* **API Management**
    * Terraform will now remove the Default API and Products for API Management when creating a new API Management instance, which is consistent with the behavior for other Terraform Providers.
* **Resource Groups**
    * Terraform will now check for Resources nested within a Resource Group prior to deletion of the resource group. If any items are found, an error will be raised. This behavior is configurable today in the features block, but disabled by default. In 3.0, this behavior will be enabled by default.
* **Storage**
    * We’ll switch to using Resource Manager (management plane) for all resources.
    * Switching to use AzureAD / Resource Manager for nested item configuration - this allows provisioning these when Private Link is enabled, however requires different permissions which are not granted by default.
    * The field `allow_blob_public_access` will be renamed to `allow_nested_items_to_be_public` to resolve confusion about what this field does. This field specifies whether items within the Storage Account (such as Containers and Blobs) can opt-in to being made public (for example at the Container or Blob level) - and not that all resources within this Storage Account are public by default.
* **Behavioral changes:**
    * All Resources: the Resource ID will now be validated at Import time to ensure the correct resource is being imported, and return the expected format upon a mismatch. While we do this for most resources today, we’ll be doing this for everything going forward. This ensures that, for example, a Virtual Machine ID is specified rather than the VM Extension ID (which is nested under a Virtual Machine ID).
    * All Resources which use `min_tls_version`: updating the default minimum TLS version to be `1.2`.
    * Resources with a (Availability) `zones` field: updating the behavior to be consistent across the Provider.
        * Availability Zones will be represented across all resources which support it using the field `zones` - in addition the values `No-Zone` and `ZoneRedundant` will be removed in favour of being explicit.
        * Where this field is Optional and Computed - this field will no longer be Computed. This means that if you wish to use the Availability Zone defaulted by Azure, you will need to use [Terraform’s `ignore_changes` functionality](https://www.terraform.io/docs/language/meta-arguments/lifecycle.html#ignore_changes) to ignore changes to this field.
        * Where this field is Optional (and isn’t defaulted by Azure) - omitting this field (or specifying a value of `null`) will deploy this without any Zones.
        * Where this field is Required, there are no changes.
        * `Zone Redundant` resources can be provisioned by specifying all of the Availability Zones for that particular Azure Region. We’ll also introduce a new `azurerm_availability_zones` data source to provide this information.
    * Resources with a (Managed) `identity` block: updating the behavior to be consistent across the Provider.
        * This means that the presence of an `identity` block means a Managed Identity should be assigned to this Resource - and the omission of an `identity` block (or a `null` value) means that no Managed Identity should be assigned to this Resource.

### Feature details: New Data Sources / Resources for App Service & Function Apps

While it’s possible to provision App Services and Function Apps in Terraform today, the design and behavior of the App Service platform has changed over the years. These resources require some refinement.

Similar to the changes for Virtual Machines in v2.0 of the Azure Provider, we’re intending to introduce more granular resources for App Service to better represent the functionality available in Azure.

Some of these new Data Sources and Resources are available as an opt-in Beta today from version 2.79 of the Azure Provider onwards - and we encourage you to try them out.

While we don’t anticipate making changes to these resources at this time - since these are in Beta, it’s possible. As such, we recommend not using this Beta in a Production environment at this time.

More information on the specific changes for App Service / Function Apps can be found in the [documentation](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs)

### Feature details: Key Vault - Soft Delete Recovery/Purging for Certificates, Keys and Secrets

Previously, soft delete has only been available for a Key Vault resource as a whole. Now, you’ll be able to soft delete the nested items within a Key Vault: certificates, keys, and secrets.

### Feature details: Switching to Microsoft Graph

The AzureRM provider needs to query the graph API in order to retrieve important information about the principal account it’s using to authenticate. We currently use the Azure Active Directory Graph API for this, but this API is deprecated and has been replaced by Microsoft Graph, so in version 3.0 of the provider we’ll be switching to the newer API. When using service principal authentication, this will require changes to API permissions that are granted to that principal and this will be covered in our upgrade guide.

We’ll also be enabling Microsoft Graph via an opt-in beta prior to version 3.0 and we encourage you to try this when it’s available, as part of your preparation for the new major version.

### Feature details: Switching to use MSAL for authentication instead of ADAL

Authentication to APIs such as Resource Manager is currently performed using the ADAL library which yields legacy v1 authentication tokens. We’ll move to use [v2 tokens](https://docs.microsoft.com/en-us/azure/active-directory/develop/access-tokens#v10-and-v20) in version 3.0 of the provider. In practice this change will not yield any noticeable behavioral differences; however, since this underpins the way the provider authenticates to Azure services, we’ll be making this change in a major release.
## _Frequently Asked Questions_

### Why is the behavior of Resource Groups changing?
Most resources in Azure are provisioned within a Resource Group, which (amongst other things) allows for easy grouping and allows scoping permissions to resources within this Resource Group.

The default behavior of the Azure Platform (and Terraform today) when deleting a Resource Group is to delete all of the items within this Resource Group.

While this feature makes it easy to clean-up any resources - since resources can be provisioned outside of Terraform, it means that these Resources are untracked by Terraform - and so Terraform is unable to show these Resources in the Plan during the deletion of the Resource Group.

Terraform has a feature-flag for this behavior available within the Features block today - which will check during the deletion of the Resource Group for any Resources within this Resource Group, and raise an error (stating these must be removed first) if any Resources are found. In v2.x versions of the Azure Provider this is disabled by default - however v3.0 will flip this default to be enabled by default.

This behavior can be configured using the features block as shown below, both in v2.x and v3.0 of the Azure Provider:

```
provider "azurerm" {
features {
resource_group {
prevent_deletion_if_contains_resources = false
          }
     }
}

resource "azurerm_resource_group" "example" {
name = "example-resources"
location = "West Europe"
}
```

Setting this value to true will check for nested Resources during deletion of the Resource Group; setting this to false will skip this check.

### When will v3 of the Azure Provider be available?
Version 3.0 of the Azure Provider is being built iteratively using Feature Toggles within the v2.x codebase. This means that functionality will be added over time until the 3.0 Release is completed.

This Feature Toggle approach has been used during the development of v2.0 of the Azure Provider and worked well - this allows users to opt-into functionality coming in v3.0 of the Provider in a 2.x release.

Since this is being worked on iteratively and the majority of behavior can be enabled prior release, v3.0 of the Azure Provider will launch when it’s features have been completed, tested, and sufficient time has pass to allow for feedback - currently we’re targeting early 2022 (however this is subject to change).

### How can I opt into the Beta?
At this point in time this isn’t publicly exposed since the changes aren’t documented - however we’re a little further along (and an upgrade guide containing all of the changes included in v3.0 is available) we’ll look to launch the Beta.

Note that functionality in the Beta is subject to change, including breaking changes - so while we’d appreciate your feedback, we’d recommend against using this in a production environment at this point in time.
